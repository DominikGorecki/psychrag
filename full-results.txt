================================================= test session starts =================================================
platform win32 -- Python 3.12.2, pytest-9.0.1, pluggy-1.6.0
rootdir: C:\code\python\psychRAG-test
configfile: pyproject.toml
testpaths: tests
plugins: anyio-4.11.0, Faker-38.2.0, langsmith-0.4.47, logfire-4.15.1, asyncio-1.3.0, html-4.1.1, markdown-docs-0.9.0, metadata-3.1.1
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 942 items

tests\unit\test_ai_config.py ................................                                                    [  3%]
tests\unit\test_api_endpoints.py ...............                                                                 [  4%]
tests\unit\test_app_config.py ...............................                                                    [  8%]
tests\unit\test_apply_title_changes.py ...........................                                               [ 11%]
tests\unit\test_augment.py ..............                                                                        [ 12%]
tests\unit\test_bib_extractor.py ..................................                                              [ 16%]
tests\unit\test_chunk_headings.py .......................................                                        [ 20%]
tests\unit\test_chunk_model.py .........................                                                         [ 23%]
tests\unit\test_consolidate_context.py ............................................................              [ 29%]
tests\unit\test_content_chunking.py ...............................................                              [ 34%]
tests\unit\test_conv_epub2md.py ............                                                                     [ 35%]
tests\unit\test_conv_pdf2md.py ...........                                                                       [ 36%]
tests\unit\test_conversion_api_endpoints.py ...........                                                          [ 38%]
tests\unit\test_database.py ....                                                                                 [ 38%]
tests\unit\test_db_health_check.py ...................................                                           [ 42%]
tests\unit\test_init_db.py .......                                                                               [ 42%]
tests\unit\test_inspection.py ........                                                                           [ 43%]
tests\unit\test_io_file_model.py .................F.                                                             [ 45%]
tests\unit\test_io_folder_data.py ............................                                                   [ 48%]
tests\unit\test_llm_citation_parser.py ...........                                                               [ 49%]
tests\unit\test_llm_factory.py ...........................................................                       [ 56%]
tests\unit\test_llm_processor.py .........................                                                       [ 58%]
tests\unit\test_new_work.py ................                                                                     [ 60%]
tests\unit\test_original_markdown.py .....                                                                       [ 61%]
tests\unit\test_pdf_bookmarks2toc.py ................                                                            [ 62%]
tests\unit\test_prompt_meta_model.py ....................                                                        [ 64%]
tests\unit\test_prompt_template_model.py ...................                                                     [ 66%]
tests\unit\test_query_embeddings.py ......................                                                       [ 69%]
tests\unit\test_query_expansion.py .........................                                                     [ 71%]
tests\unit\test_query_model.py ......................                                                            [ 74%]
tests\unit\test_rag_config_api.py ..............                                                                 [ 75%]
tests\unit\test_rag_config_db.py .............                                                                   [ 77%]
tests\unit\test_rag_config_integration.py ...............                                                        [ 78%]
tests\unit\test_rag_config_loader.py .............                                                               [ 80%]
tests\unit\test_result_model.py ...............                                                                  [ 81%]
tests\unit\test_retrieve.py ...............................................                                      [ 86%]
tests\unit\test_seed_templates.py ..............                                                                 [ 88%]
tests\unit\test_style_v_hier.py .....................................                                            [ 92%]
tests\unit\test_suggested_chunks.py .................................                                            [ 95%]
tests\unit\test_template_loader.py ...........                                                                   [ 96%]
tests\unit\test_templates_api.py ..........................                                                      [ 99%]
tests\unit\test_work_model.py .....                                                                              [100%]

====================================================== FAILURES =======================================================
___________________________________ TestIOFileTimestamps.test_last_seen_at_updates ____________________________________

self = <test_io_file_model.TestIOFileTimestamps object at 0x0000020C840A04A0>
session = <sqlalchemy.orm.session.Session object at 0x0000020C85FA2C00>

    def test_last_seen_at_updates(self, session):
        """Test that last_seen_at can be updated."""
        io_file = IOFile(
            filename="test.pdf",
            file_type=FileType.INPUT,
            file_path="/path/to/test.pdf"
        )
        session.add(io_file)
        session.commit()
    
        original_last_seen = io_file.last_seen_at
    
        # Update last_seen_at
        new_time = datetime.now(timezone.utc)
        io_file.last_seen_at = new_time
        session.commit()
    
        # SQLite returns naive datetimes, so compare timestamps or convert both to naive
        retrieved_naive = io_file.last_seen_at.replace(tzinfo=None) if io_file.last_seen_at.tzinfo else io_file.last_seen_at
        expected_naive = new_time.replace(tzinfo=None)
        # Allow small difference due to database round-trip
        assert abs((retrieved_naive - expected_naive).total_seconds()) < 1
>       assert io_file.last_seen_at != original_last_seen
E       AssertionError: assert datetime.datetime(2025, 12, 4, 22, 11, 24, 254609) != datetime.datetime(2025, 12, 4, 22, 11, 24, 254609)
E        +  where datetime.datetime(2025, 12, 4, 22, 11, 24, 254609) = <IOFile(id=1, filename='test.pdf', type='input')>.last_seen_at

tests\unit\test_io_file_model.py:324: AssertionError
=============================================== short test summary info ===============================================
FAILED tests/unit/test_io_file_model.py::TestIOFileTimestamps::test_last_seen_at_updates - AssertionError: assert dat...
=========================================== 1 failed, 941 passed in 24.04s ============================================
