================================================= test session starts =================================================
platform win32 -- Python 3.12.2, pytest-9.0.1, pluggy-1.6.0
rootdir: C:\code\python\psychRAG-test
configfile: pyproject.toml
testpaths: tests
plugins: anyio-4.11.0, Faker-38.2.0, langsmith-0.4.47, logfire-4.15.1, asyncio-1.3.0, html-4.1.1, markdown-docs-0.9.0, metadata-3.1.1
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 1024 items

tests\unit\test_ai_config.py ................................                                                    [  3%]
tests\unit\test_api_endpoints.py ..............                                                                  [  4%]
tests\unit\test_app_config.py ...............................                                                    [  7%]
tests\unit\test_apply_title_changes.py ...........................                                               [ 10%]
tests\unit\test_apply_title_edits.py .............................                                               [ 12%]
tests\unit\test_augment.py .FF...........                                                                        [ 14%]
tests\unit\test_bib_extractor.py ..................................                                              [ 17%]
tests\unit\test_chunk_headings.py .......................................                                        [ 21%]
tests\unit\test_chunk_model.py ................                                                                  [ 23%]
tests\unit\test_consolidate_context.py ............................................................              [ 28%]
tests\unit\test_content_chunking.py ...............................................                              [ 33%]
tests\unit\test_conv_epub2md.py ............                                                                     [ 34%]
tests\unit\test_conv_pdf2md.py ...........                                                                       [ 35%]
tests\unit\test_conversion_api_endpoints.py ...........                                                          [ 36%]
tests\unit\test_database.py ....                                                                                 [ 37%]
tests\unit\test_db_health_check.py ...................................                                           [ 40%]
tests\unit\test_delete_conversion.py .........                                                                   [ 41%]
tests\unit\test_env_utils.py ...............                                                                     [ 42%]
tests\unit\test_extract_titles.py ......................................                                         [ 46%]
tests\unit\test_extract_toc.py .............................                                                     [ 49%]
tests\unit\test_init_db.py ...F...                                                                               [ 50%]
tests\unit\test_inspection.py ........                                                                           [ 50%]
tests\unit\test_io_file_model.py .............                                                                   [ 52%]
tests\unit\test_io_folder_data.py ............................                                                   [ 54%]
tests\unit\test_llm_citation_parser.py ...........                                                               [ 56%]
tests\unit\test_llm_factory.py ...........................................................                       [ 61%]
tests\unit\test_llm_processor.py .........................                                                       [ 64%]
tests\unit\test_new_work.py ................                                                                     [ 65%]
tests\unit\test_original_markdown.py .....                                                                       [ 66%]
tests\unit\test_pdf_bookmarks2toc.py ................                                                            [ 67%]
tests\unit\test_prompt_meta_model.py ............                                                                [ 69%]
tests\unit\test_prompt_template_model.py ............                                                            [ 70%]
tests\unit\test_query_embeddings.py ......................                                                       [ 72%]
tests\unit\test_query_expansion.py .........................                                                     [ 74%]
tests\unit\test_query_model.py ...................                                                               [ 76%]
tests\unit\test_rag_config_api.py .FFF..F.......                                                                 [ 78%]
tests\unit\test_rag_config_db.py .......F.....                                                                   [ 79%]
tests\unit\test_rag_config_integration.py ...............                                                        [ 80%]
tests\unit\test_rag_config_loader.py ........F..F.                                                               [ 82%]
tests\unit\test_result_model.py ...........                                                                      [ 83%]
tests\unit\test_retrieve.py ...............................................                                      [ 87%]
tests\unit\test_seed_templates.py ..............                                                                 [ 89%]
tests\unit\test_style_v_hier.py .....................................                                            [ 92%]
tests\unit\test_suggested_chunks.py .................................                                            [ 95%]
tests\unit\test_template_loader.py ...........                                                                   [ 96%]
tests\unit\test_templates_api.py ..........................                                                      [ 99%]
tests\unit\test_work_model.py .....                                                                              [100%]

====================================================== FAILURES =======================================================
__________________________________ TestGetQueryWithContext.test_get_query_not_found ___________________________________

self = <tests.unit.test_augment.TestGetQueryWithContext object at 0x00000155276C8140>
mock_get_session = <MagicMock name='get_session' id='1465252942656'>

    @patch('psychrag.augmentation.augment.get_session')
    def test_get_query_not_found(self, mock_get_session):
        """Test error when query not found."""
        mock_session = MagicMock()
        mock_session.query.return_value.filter.return_value.first.return_value = None
        mock_get_session.return_value.__enter__.return_value = mock_session
    
        with pytest.raises(ValueError, match="Query with id=999 not found"):
>           get_query_with_context(999)

tests\unit\test_augment.py:58: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\psychrag\augmentation\augment.py:117: in get_query_with_context
    config = get_default_config()
             ^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    def get_default_config() -> dict:
        """
        Get default RAG configuration from database.
    
        Returns the configuration dict for the preset marked as default.
        This is the primary function used by RAG pipeline modules.
    
        Returns:
            Dict with keys: "retrieval", "consolidation", "augmentation".
            Each key contains a dict of parameters for that stage.
    
        Raises:
            RuntimeError: If no default configuration exists in database.
    
        Example:
            >>> config = get_default_config()
            >>> config["retrieval"]["dense_limit"]
            19
            >>> config["consolidation"]["coverage_threshold"]
            0.5
        """
        with get_session() as session:
            config = session.query(RagConfig).filter(RagConfig.is_default == True).first()
            if not config:
>               raise RuntimeError(
                    "No default RAG configuration found in database. "
                    "Run database initialization to create default preset."
                )
E               RuntimeError: No default RAG configuration found in database. Run database initialization to create default preset.

src\psychrag\utils\rag_config_loader.py:46: RuntimeError
_________________________________ TestGetQueryWithContext.test_get_query_no_contexts __________________________________

self = <tests.unit.test_augment.TestGetQueryWithContext object at 0x00000155276C8440>
mock_get_session = <MagicMock name='get_session' id='1465255290560'>

    @patch('psychrag.augmentation.augment.get_session')
    def test_get_query_no_contexts(self, mock_get_session):
        """Test query with no contexts."""
        mock_query = Mock(spec=Query)
        mock_query.id = 1
        mock_query.clean_retrieval_context = None
    
        mock_session = MagicMock()
        mock_session.query.return_value.filter.return_value.first.return_value = mock_query
        mock_get_session.return_value.__enter__.return_value = mock_session
    
>       query, contexts = get_query_with_context(1)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_augment.py:71: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\psychrag\augmentation\augment.py:117: in get_query_with_context
    config = get_default_config()
             ^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    def get_default_config() -> dict:
        """
        Get default RAG configuration from database.
    
        Returns the configuration dict for the preset marked as default.
        This is the primary function used by RAG pipeline modules.
    
        Returns:
            Dict with keys: "retrieval", "consolidation", "augmentation".
            Each key contains a dict of parameters for that stage.
    
        Raises:
            RuntimeError: If no default configuration exists in database.
    
        Example:
            >>> config = get_default_config()
            >>> config["retrieval"]["dense_limit"]
            19
            >>> config["consolidation"]["coverage_threshold"]
            0.5
        """
        with get_session() as session:
            config = session.query(RagConfig).filter(RagConfig.is_default == True).first()
            if not config:
>               raise RuntimeError(
                    "No default RAG configuration found in database. "
                    "Run database initialization to create default preset."
                )
E               RuntimeError: No default RAG configuration found in database. Run database initialization to create default preset.

src\psychrag\utils\rag_config_loader.py:46: RuntimeError
_____________________________________ TestInitDatabase.test_calls_both_functions ______________________________________

self = <sqlalchemy.engine.base.Connection object at 0x0000015529364AD0>
dialect = <sqlalchemy.dialects.postgresql.psycopg.PGDialect_psycopg object at 0x0000015533424E00>
context = <sqlalchemy.dialects.postgresql.psycopg.PGExecutionContext_psycopg object at 0x00000155295C2150>
statement = <sqlalchemy.dialects.postgresql.psycopg.PGCompiler_psycopg object at 0x00000155295C1DF0>, parameters = [{}]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

venv\Lib\site-packages\sqlalchemy\engine\base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
venv\Lib\site-packages\sqlalchemy\engine\default.py:951: in do_execute
    cursor.execute(statement, parameters)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <psycopg.Cursor [closed] [IDLE] (host=127.0.0.1 user=psych_rag_app_user_test database=psych_rag_test) at 0x15527b0f890>
query = '\n            CREATE OR REPLACE FUNCTION update_prompt_meta_updated_at()\n            RETURNS TRIGGER AS $$\n        ...ated_at = CURRENT_TIMESTAMP;\n                RETURN NEW;\n            END;\n            $$ LANGUAGE plpgsql\n        '
params = {}

    def execute(
        self,
        query: Query,
        params: Params | None = None,
        *,
        prepare: bool | None = None,
        binary: bool | None = None,
    ) -> Self:
        """
        Execute a query or command to the database.
        """
        try:
            with self._conn.lock:
                self._conn.wait(
                    self._execute_gen(query, params, prepare=prepare, binary=binary)
                )
        except e._NO_TRACEBACK as ex:
>           raise ex.with_traceback(None)
E           psycopg.errors.InsufficientPrivilege: must be owner of function update_prompt_meta_updated_at

venv\Lib\site-packages\psycopg\cursor.py:97: InsufficientPrivilege

The above exception was the direct cause of the following exception:

self = <tests.unit.test_init_db.TestInitDatabase object at 0x0000015527895430>
mock_create_db = <MagicMock name='create_database_and_user' id='1465275270880'>
mock_create_tables = <MagicMock name='create_tables' id='1465274880400'>

    @patch("psychrag.data.init_db.create_tables")
    @patch("psychrag.data.init_db.create_database_and_user")
    def test_calls_both_functions(self, mock_create_db, mock_create_tables):
        """Test that init_database calls both setup functions."""
>       init_database(verbose=True)

tests\unit\test_init_db.py:81: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\psychrag\data\init_db.py:501: in init_database
    create_prompt_meta_table(verbose=verbose)
src\psychrag\data\init_db.py:293: in create_prompt_meta_table
    conn.execute(text("""
venv\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
venv\Lib\site-packages\sqlalchemy\sql\elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
venv\Lib\site-packages\sqlalchemy\engine\base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
venv\Lib\site-packages\sqlalchemy\engine\base.py:1846: in _execute_context
    return self._exec_single_context(
venv\Lib\site-packages\sqlalchemy\engine\base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
venv\Lib\site-packages\sqlalchemy\engine\base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
venv\Lib\site-packages\sqlalchemy\engine\base.py:1967: in _exec_single_context
    self.dialect.do_execute(
venv\Lib\site-packages\sqlalchemy\engine\default.py:951: in do_execute
    cursor.execute(statement, parameters)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <psycopg.Cursor [closed] [IDLE] (host=127.0.0.1 user=psych_rag_app_user_test database=psych_rag_test) at 0x15527b0f890>
query = '\n            CREATE OR REPLACE FUNCTION update_prompt_meta_updated_at()\n            RETURNS TRIGGER AS $$\n        ...ated_at = CURRENT_TIMESTAMP;\n                RETURN NEW;\n            END;\n            $$ LANGUAGE plpgsql\n        '
params = {}

    def execute(
        self,
        query: Query,
        params: Params | None = None,
        *,
        prepare: bool | None = None,
        binary: bool | None = None,
    ) -> Self:
        """
        Execute a query or command to the database.
        """
        try:
            with self._conn.lock:
                self._conn.wait(
                    self._execute_gen(query, params, prepare=prepare, binary=binary)
                )
        except e._NO_TRACEBACK as ex:
>           raise ex.with_traceback(None)
E           sqlalchemy.exc.ProgrammingError: (psycopg.errors.InsufficientPrivilege) must be owner of function update_prompt_meta_updated_at
E           [SQL: 
E                       CREATE OR REPLACE FUNCTION update_prompt_meta_updated_at()
E                       RETURNS TRIGGER AS $$
E                       BEGIN
E                           NEW.updated_at = CURRENT_TIMESTAMP;
E                           RETURN NEW;
E                       END;
E                       $$ LANGUAGE plpgsql
E                   ]
E           (Background on this error at: https://sqlalche.me/e/20/f405)

venv\Lib\site-packages\psycopg\cursor.py:97: ProgrammingError
------------------------------------------------ Captured stdout call -------------------------------------------------
Enabling pgvector extension...
pgvector extension enabled
Creating vector indexes...
Vector indexes created successfully
Creating full-text search infrastructure...
Transferred ownership of full-text search function to psych_rag_app_user_test
Full-text search infrastructure created successfully
Creating prompt_meta table...
___________________________________ TestListPresets.test_list_presets_default_first ___________________________________

self = <tests.unit.test_rag_config_api.TestListPresets object at 0x0000015527A1DC10>

    def test_list_presets_default_first(self):
        """Test that default preset appears first in list."""
        response = client.get("/api/rag-config/")
        data = response.json()
    
        # First item should be default
>       assert data[0]["is_default"] is True
E       assert False is True

tests\unit\test_rag_config_api.py:36: AssertionError
____________________________________ TestGetDefaultPreset.test_get_default_success ____________________________________

self = <tests.unit.test_rag_config_api.TestGetDefaultPreset object at 0x0000015527A3E810>

    def test_get_default_success(self):
        """Test successful retrieval of default preset."""
        response = client.get("/api/rag-config/default")
>       assert response.status_code == 200
E       assert 404 == 200
E        +  where 404 = <Response [404 Not Found]>.status_code

tests\unit\test_rag_config_api.py:45: AssertionError
_________________________________ TestGetPresetByName.test_get_preset_by_name_success _________________________________

self = <tests.unit.test_rag_config_api.TestGetPresetByName object at 0x0000015527A3E330>

    def test_get_preset_by_name_success(self):
        """Test successful retrieval by name."""
        response = client.get("/api/rag-config/Default")
>       assert response.status_code == 200
E       assert 404 == 200
E        +  where 404 = <Response [404 Not Found]>.status_code

tests\unit\test_rag_config_api.py:59: AssertionError
_________________________________ TestCreatePreset.test_create_preset_duplicate_name __________________________________

self = <tests.unit.test_rag_config_api.TestCreatePreset object at 0x0000015527A3CA10>

    def test_create_preset_duplicate_name(self):
        """Test 409 conflict for duplicate name."""
        payload = {
            "preset_name": "Default",  # Existing preset
            "is_default": False,
            "config": {
                "retrieval": {
                    "dense_limit": 19,
                    "lexical_limit": 5,
                    "rrf_k": 50,
                    "top_k_rrf": 75,
                    "top_n_final": 17,
                    "entity_boost": 0.05,
                    "min_word_count": 150,
                    "min_char_count": 250,
                    "min_content_length": 750,
                    "enrich_lines_above": 0,
                    "enrich_lines_below": 13,
                    "mmr_lambda": 0.7,
                    "reranker_batch_size": 8,
                    "reranker_max_length": 512
                },
                "consolidation": {
                    "coverage_threshold": 0.5,
                    "line_gap": 7,
                    "min_content_length": 350,
                    "enrich_from_md": True
                },
                "augmentation": {
                    "top_n_contexts": 5
                }
            }
        }
    
        response = client.post("/api/rag-config/", json=payload)
>       assert response.status_code == 409
E       assert 201 == 409
E        +  where 201 = <Response [201 Created]>.status_code

tests\unit\test_rag_config_api.py:154: AssertionError
__________________________________ TestDefaultPresetSeed.test_default_preset_exists ___________________________________

self = <tests.unit.test_rag_config_db.TestDefaultPresetSeed object at 0x0000015527A6D4F0>

    def test_default_preset_exists(self):
        """Verify default preset was created."""
        with engine.connect() as conn:
            result = conn.execute(text("""
                SELECT preset_name, is_default, description
                FROM rag_config
                WHERE preset_name = 'Default'
            """))
            row = result.fetchone()
    
            assert row is not None
            assert row[0] == 'Default'
            assert row[1] == True  # Use equality check, not identity check
>           assert row[2] is not None
E           assert None is not None

tests\unit\test_rag_config_db.py:187: AssertionError
__________________________ TestGetAllPresetNames.test_get_all_preset_names_includes_default ___________________________

self = <tests.unit.test_rag_config_loader.TestGetAllPresetNames object at 0x0000015527A95B50>

    def test_get_all_preset_names_includes_default(self):
        """Test that default preset is included."""
        names = get_all_preset_names()
>       assert "Default" in names
E       AssertionError: assert 'Default' in ['Balanced', 'Test Settings']

tests\unit\test_rag_config_loader.py:149: AssertionError
_________________________________________ TestRagConfigModel.test_model_repr __________________________________________

self = <tests.unit.test_rag_config_loader.TestRagConfigModel object at 0x0000015527A95850>

    def test_model_repr(self):
        """Test __repr__ method."""
        with get_session() as session:
            default = session.query(RagConfig).filter(RagConfig.is_default == True).first()
            repr_str = repr(default)
    
>           assert "RagConfig" in repr_str
E           AssertionError: assert 'RagConfig' in 'None'

tests\unit\test_rag_config_loader.py:219: AssertionError
=============================================== short test summary info ===============================================
FAILED tests/unit/test_augment.py::TestGetQueryWithContext::test_get_query_not_found - RuntimeError: No default RAG c...
FAILED tests/unit/test_augment.py::TestGetQueryWithContext::test_get_query_no_contexts - RuntimeError: No default RAG...
FAILED tests/unit/test_init_db.py::TestInitDatabase::test_calls_both_functions - sqlalchemy.exc.ProgrammingError: (ps...
FAILED tests/unit/test_rag_config_api.py::TestListPresets::test_list_presets_default_first - assert False is True
FAILED tests/unit/test_rag_config_api.py::TestGetDefaultPreset::test_get_default_success - assert 404 == 200
FAILED tests/unit/test_rag_config_api.py::TestGetPresetByName::test_get_preset_by_name_success - assert 404 == 200
FAILED tests/unit/test_rag_config_api.py::TestCreatePreset::test_create_preset_duplicate_name - assert 201 == 409
FAILED tests/unit/test_rag_config_db.py::TestDefaultPresetSeed::test_default_preset_exists - assert None is not None
FAILED tests/unit/test_rag_config_loader.py::TestGetAllPresetNames::test_get_all_preset_names_includes_default - Asse...
FAILED tests/unit/test_rag_config_loader.py::TestRagConfigModel::test_model_repr - AssertionError: assert 'RagConfig'...
========================================== 10 failed, 1014 passed in 54.73s ===========================================
