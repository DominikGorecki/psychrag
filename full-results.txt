================================================= test session starts =================================================
platform win32 -- Python 3.12.2, pytest-9.0.1, pluggy-1.6.0
rootdir: C:\code\python\psychRAG-test
configfile: pyproject.toml
testpaths: tests
plugins: anyio-4.11.0, Faker-38.2.0, langsmith-0.4.47, logfire-4.15.1, asyncio-1.3.0, html-4.1.1, markdown-docs-0.9.0, metadata-3.1.1
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 1024 items

tests\unit\test_ai_config.py ................................                                                    [  3%]
tests\unit\test_api_endpoints.py ..............                                                                  [  4%]
tests\unit\test_app_config.py ...............................                                                    [  7%]
tests\unit\test_apply_title_changes.py ...........................                                               [ 10%]
tests\unit\test_apply_title_edits.py .............................                                               [ 12%]
tests\unit\test_augment.py ..............                                                                        [ 14%]
tests\unit\test_bib_extractor.py ..................................                                              [ 17%]
tests\unit\test_chunk_headings.py .......................................                                        [ 21%]
tests\unit\test_chunk_model.py ................                                                                  [ 23%]
tests\unit\test_consolidate_context.py ............................................................              [ 28%]
tests\unit\test_content_chunking.py ...............................................                              [ 33%]
tests\unit\test_conv_epub2md.py ............                                                                     [ 34%]
tests\unit\test_conv_pdf2md.py ...........                                                                       [ 35%]
tests\unit\test_conversion_api_endpoints.py ...........                                                          [ 36%]
tests\unit\test_database.py ....                                                                                 [ 37%]
tests\unit\test_db_health_check.py ...................................                                           [ 40%]
tests\unit\test_delete_conversion.py .........                                                                   [ 41%]
tests\unit\test_env_utils.py ...............                                                                     [ 42%]
tests\unit\test_extract_titles.py ......................................                                         [ 46%]
tests\unit\test_extract_toc.py .............................                                                     [ 49%]
tests\unit\test_init_db.py ...F...                                                                               [ 50%]
tests\unit\test_inspection.py ........                                                                           [ 50%]
tests\unit\test_io_file_model.py .............                                                                   [ 52%]
tests\unit\test_io_folder_data.py ............................                                                   [ 54%]
tests\unit\test_llm_citation_parser.py ...........                                                               [ 56%]
tests\unit\test_llm_factory.py ...........................................................                       [ 61%]
tests\unit\test_llm_processor.py .........................                                                       [ 64%]
tests\unit\test_new_work.py ................                                                                     [ 65%]
tests\unit\test_original_markdown.py .....                                                                       [ 66%]
tests\unit\test_pdf_bookmarks2toc.py ................                                                            [ 67%]
tests\unit\test_prompt_meta_model.py ............                                                                [ 69%]
tests\unit\test_prompt_template_model.py ............                                                            [ 70%]
tests\unit\test_query_embeddings.py ......................                                                       [ 72%]
tests\unit\test_query_expansion.py .........................                                                     [ 74%]
tests\unit\test_query_model.py ...................                                                               [ 76%]
tests\unit\test_rag_config_api.py ..............                                                                 [ 78%]
tests\unit\test_rag_config_db.py .............                                                                   [ 79%]
tests\unit\test_rag_config_integration.py ...............                                                        [ 80%]
tests\unit\test_rag_config_loader.py .............                                                               [ 82%]
tests\unit\test_result_model.py ...........                                                                      [ 83%]
tests\unit\test_retrieve.py ...............................................                                      [ 87%]
tests\unit\test_seed_templates.py ..............                                                                 [ 89%]
tests\unit\test_style_v_hier.py .....................................                                            [ 92%]
tests\unit\test_suggested_chunks.py .................................                                            [ 95%]
tests\unit\test_template_loader.py ...........                                                                   [ 96%]
tests\unit\test_templates_api.py ..........................                                                      [ 99%]
tests\unit\test_work_model.py .....                                                                              [100%]

====================================================== FAILURES =======================================================
_____________________________________ TestInitDatabase.test_calls_both_functions ______________________________________

self = <tests.unit.test_init_db.TestInitDatabase object at 0x000001FB253F89B0>
mock_create_db = <MagicMock name='create_database_and_user' id='2178203942208'>
mock_enable_pgvector = <MagicMock name='enable_pgvector_extension' id='2178203356096'>
mock_create_tables = <MagicMock name='create_tables' id='2178203941632'>
mock_create_vector_indexes = <MagicMock name='create_vector_indexes' id='2178203937792'>
mock_create_fulltext_search = <MagicMock name='create_fulltext_search' id='2178203934000'>
mock_create_prompt_meta_table = <MagicMock name='create_prompt_meta_table' id='2178203930160'>
mock_seed_prompt_templates = <MagicMock name='seed_prompt_templates' id='2178203893488'>
mock_create_default_rag_config = <MagicMock name='create_default_rag_config' id='2178203360128'>

    @patch("psychrag.data.init_db.create_default_rag_config")
    @patch("psychrag.data.init_db.seed_prompt_templates")
    @patch("psychrag.data.init_db.create_prompt_meta_table")
    @patch("psychrag.data.init_db.create_fulltext_search")
    @patch("psychrag.data.init_db.create_vector_indexes")
    @patch("psychrag.data.init_db.create_tables")
    @patch("psychrag.data.init_db.enable_pgvector_extension")
    @patch("psychrag.data.init_db.create_database_and_user")
    def test_calls_both_functions(
        self,
        mock_create_db,
        mock_enable_pgvector,
        mock_create_tables,
        mock_create_vector_indexes,
        mock_create_fulltext_search,
        mock_create_prompt_meta_table,
        mock_seed_prompt_templates,
        mock_create_default_rag_config,
    ):
        """Test that init_database calls all setup functions."""
        init_database(verbose=True)
    
        mock_create_db.assert_called_once_with(verbose=True)
>       mock_enable_pgvector.assert_called_once_with(verbose=verbose)
                                                             ^^^^^^^
E       NameError: name 'verbose' is not defined

tests\unit\test_init_db.py:100: NameError
------------------------------------------------ Captured stdout call -------------------------------------------------
Database initialization complete
=============================================== short test summary info ===============================================
FAILED tests/unit/test_init_db.py::TestInitDatabase::test_calls_both_functions - NameError: name 'verbose' is not def...
=========================================== 1 failed, 1023 passed in 32.08s ===========================================
